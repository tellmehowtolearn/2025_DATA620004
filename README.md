# 2025_DATA620004
2025春季学期神经网络和深度学习第一次作业（从零开始构建三层神经网络分类器，实现图像分类）模型训练与测试说明文档

## 1. 参数查找：多超参数组合的网格搜索

本项目通过网格搜索方式对以下六个关键超参数进行了系统组合评估：

- 第一层隐藏层大小：`[256, 512]`
- 第二层隐藏层大小：`[128, 256]`
- 学习率：`[1e-4, 1e-3, 1e-2]`
- 正则化强度（L2）：`[0, 1e-5]`
- 批量大小（batch_size）：`[32, 64, 128]`
- 激活函数：`['relu', 'tanh']`

总共组合数为 $2 \times 2 \times 3 \times 2 \times 3 \times 2 = 144$ 种。所有组合均使用相同训练轮数（200轮）进行训练，并在验证集上评估性能。最终选取验证集损失最小且准确率最高的超参数组合作为最终模型配置。

超参数搜索逻辑实现于 [`hyperparameter_search.py`](./hyperparameter_search.py)，最优参数将自动保存为 `data/best_params_<timestamp>.pkl` 文件。

---

## 2. 模型训练说明

模型训练流程基于 `train.py` 中定义的 `Trainer` 类与`network.py`中定义的 `ThreeLayerFNN` 类，支持完整训练、日志记录、模型保存与绘图。

### 2.1 激活函数

测试`ReLU` 与 `Tanh` 两种激活函数通过，可由参数动态指定，默认在超参数搜索中进行选择。

### 2.2 反向传播、损失与梯度计算

- 损失函数采用交叉熵加 L2 正则化形式（定义在 `compute_loss` 函数中）。
- 梯度计算依照链式法则进行（Downstream Gradient = Local Gradient × Upstream Gradient），最终对权重矩阵 $W_1$, $W_2$, $W_3$, $b_1$,$b_2$,$b_3$ 进行梯度更新，逻辑封装在 `backward` 方法中。
- softmax 对数损失的梯度简化为 `softmax - y_truth`，可直接应用。

### 2.3 学习率下降策略

每个epoch之后，学习率按照指数衰减策略下降（`lr *= lr_decay`），其中 `lr_decay = 0.95`。

### 2.4 L2 正则化

正则化项定义为：

$$
\frac{\lambda}{2} \|W_1\|_2^2 + \frac{\lambda}{2} \|W_2\|_2^2 + \frac{\lambda}{2} \|W_3\|_2^2
$$

最终梯度需加上 $\lambda W_1$ 、$\lambda W_2$、$\lambda W_3$  项。

### 2.5 SGD 优化器

采用小批量梯度下降（SGD），每次训练选取 `batch_size` 大小的样本子集进行前向传播和反向传播，提升训练效率。

### 2.6 模型保存与训练历史

- 训练过程中自动保存模型权重（`w1`, `b1`, `w2`, `b2`, `w3`, `b3`）至trainer.best_model_params，如果最终需要保存为文件，就使用`save_best_model()`方法。
- 同时记录训练与验证过程中的损失与准确率，并能够绘图输出。

---

### 最终模型训练

最终模型训练阶段基于参数搜索阶段获得的最优超参数组合，在完整的训练集（去除验证集）上进行充分训练。训练过程中，模型自动记录训练与验证集的损失与准确率，并生成可视化曲线图。

训练由 [`train.py`](./train.py) 中的 `main()` 函数统一控制，实现包括：标准输出与日志同步写入、训练历史绘图、最佳模型自动保存等功能。训练完成后，可通过 [`test.py`](./test.py) 对保存模型进行测试集准确率评估，实现完整的训练–推理闭环。

---

## 3. 测试流程

测试过程由 `test.py` 脚本完成，主要功能包括：

- 自动加载最优参数配置（从 `data/best_params_*.pkl` 中读取）
- 加载训练完成的模型权重
- 在测试集上进行前向推理，输出准确率（Accuracy）

---

## 4. 使用流程（推荐顺序）

```bash
# 第一步：进行超参数搜索（含模型初步训练）
python search_param.py

# 第二步：使用最佳参数在完整训练集上重新训练模型
python train.py

# 第三步：加载保存模型，在测试集上评估准确率
python test.py
